name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  EXPO_CLI_VERSION: 'latest'

jobs:
  # ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° ĞºĞ¾Ğ´Ğ°
  code-quality:
    name: ğŸ“ Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: ğŸ“ TypeScript check
        run: npx tsc --noEmit
        
      - name: ğŸ§¹ ESLint check
        run: npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0
        continue-on-error: true
        
      - name: ğŸ’… Prettier check
        run: npx prettier --check .
        continue-on-error: true

  # ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  tests:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: ğŸ§ª Run tests
        run: npm test -- --coverage --watchAll=false
        continue-on-error: true
        
      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # ğŸ”’ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: ğŸ”’ Security audit
        run: node scripts/security-audit.js
        
      - name: ğŸ›¡ï¸ CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript
          
      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  # âš¡ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ
  performance:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: âš¡ Performance check
        run: node scripts/performance-check.js

  # ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [code-quality, tests, security, performance]
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: ğŸ—ï¸ Build project
        run: npx expo export --platform web
        
      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-files
          path: |
            dist/
          retention-days: 7

  # ğŸš€ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-files
          
      - name: ğŸš€ Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          # Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ğ½Ğ° staging
          # ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ñ‡ĞµÑ€ĞµĞ· EAS Build Ğ¸Ğ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ
          
      - name: ğŸ“± Trigger EAS Build (Staging)
        run: |
          echo "ğŸ“± Triggering EAS Build for staging..."
          # npx eas build --platform all --profile staging
          
      - name: ğŸ“Š Post-deployment tests
        run: |
          echo "ğŸ§ª Running post-deployment tests..."
          # Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ smoke tests

  # ğŸŒŸ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Production
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-files
          
      - name: ğŸŒŸ Deploy to production
        run: |
          echo "ğŸŒŸ Deploying to production environment..."
          # Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ğ½Ğ° production
          
      - name: ğŸ“± Trigger EAS Build (Production)
        run: |
          echo "ğŸ“± Triggering EAS Build for production..."
          # npx eas build --platform all --profile production
          
      - name: ğŸ“Š Post-deployment tests
        run: |
          echo "ğŸ§ª Running post-deployment tests..."
          
      - name: ğŸ·ï¸ Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          draft: false
          prerelease: false

  # ğŸ“¢ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
  notifications:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [code-quality, tests, security, performance, build]
    if: always()
    
    steps:
      - name: ğŸ“¢ Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#fixdrive-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        if: always()
        
      - name: ğŸ“± Telegram notification
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            MESSAGE="âœ… FixDrive CI/CD: All checks passed! ğŸš€"
          else
            MESSAGE="âŒ FixDrive CI/CD: Some checks failed! ğŸ”§"
          fi
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"$MESSAGE\",
              \"parse_mode\": \"HTML\"
            }"
        if: always()

  # ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ§¹ Cleanup artifacts
        run: |
          echo "ğŸ§¹ Cleaning up old artifacts..."
          # Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²