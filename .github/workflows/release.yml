name: ğŸ·ï¸ Release Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ·ï¸ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
  create-release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Version: $VERSION"
          
      - name: ğŸ“ Generate changelog
        id: changelog
        run: |
          echo "ğŸ“ Generating changelog..."
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‚ĞµĞ³
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG="ğŸ‰ Initial release v${{ steps.version.outputs.version }}"
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $LAST_TAG..HEAD)
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸ“Š Update package.json version
        run: |
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          
      - name: ğŸ·ï¸ Create Git tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

  # ğŸ“± Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼
  build-mobile:
    name: ğŸ“± Build Mobile Apps
    runs-on: ubuntu-latest
    needs: create-release
    
    strategy:
      matrix:
        platform: [android, ios]
        
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: ğŸ—ï¸ Setup Expo
        run: |
          npm install -g @expo/cli@latest
          npx expo install --fix
          
      - name: ğŸ“± Build for ${{ matrix.platform }}
        run: |
          echo "ğŸ“± Building for ${{ matrix.platform }}..."
          # npx eas build --platform ${{ matrix.platform }} --profile production
          
      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: mobile-build-${{ matrix.platform }}-v${{ needs.create-release.outputs.version }}
          path: |
            build/
          retention-days: 30

  # ğŸŒ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ²ĞµĞ±-Ğ²ĞµÑ€ÑĞ¸Ğ¸
  build-web:
    name: ğŸŒ Build Web App
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: ğŸŒ Build web app
        run: |
          echo "ğŸŒ Building web app..."
          # npm run build:web
          
      - name: ğŸ“¦ Upload web build
        uses: actions/upload-artifact@v3
        with:
          name: web-build-v${{ needs.create-release.outputs.version }}
          path: |
            dist/
            build/
          retention-days: 30

  # ğŸš€ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
  deploy-release:
    name: ğŸš€ Deploy Release
    runs-on: ubuntu-latest
    needs: [create-release, build-mobile, build-web]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./artifacts
          
      - name: ğŸš€ Deploy to production
        run: |
          echo "ğŸš€ Deploying release v${{ needs.create-release.outputs.version }}..."
          # Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
          
      - name: ğŸ“Š Post-deployment verification
        run: |
          echo "ğŸ“Š Verifying deployment..."
          # Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸

  # ğŸ“¢ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ñ€ĞµĞ»Ğ¸Ğ·Ğµ
  release-notifications:
    name: ğŸ“¢ Release Notifications
    runs-on: ubuntu-latest
    needs: [create-release, deploy-release]
    if: always()
    
    steps:
      - name: ğŸ“¢ Slack release notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#fixdrive-releases'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          custom_payload: |
            {
              "text": "ğŸ·ï¸ New FixDrive Release: v${{ needs.create-release.outputs.version }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ·ï¸ FixDrive v${{ needs.create-release.outputs.version }} Released!* ğŸš€"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Changelog:*\n```${{ needs.create-release.outputs.changelog }}```"
                  }
                }
              ]
            }
        if: always()
        
      - name: ğŸ“± Telegram release notification
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            MESSAGE="ğŸ·ï¸ <b>FixDrive v${{ needs.create-release.outputs.version }}</b> released! ğŸš€

<b>Changelog:</b>
<pre>${{ needs.create-release.outputs.changelog }}</pre>

ğŸ‰ Download the latest version now!"
          else
            MESSAGE="âŒ FixDrive release v${{ needs.create-release.outputs.version }} failed! ğŸ”§"
          fi
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"$MESSAGE\",
              \"parse_mode\": \"HTML\"
            }"
        if: always()
