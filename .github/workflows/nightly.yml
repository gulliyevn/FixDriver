name: ğŸŒ™ Nightly Maintenance

on:
  schedule:
    # ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 02:00 UTC (05:00 MSK)
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ” ĞĞ¾Ñ‡Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
  nightly-security:
    name: ğŸ”’ Nightly Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: ğŸ”’ Full security audit
        run: |
          echo "ğŸ”’ Running comprehensive security audit..."
          npm audit --audit-level=moderate
          
      - name: ğŸ›¡ï¸ Dependency vulnerability scan
        run: |
          echo "ğŸ›¡ï¸ Scanning for dependency vulnerabilities..."
          npx audit-ci --config .audit-ci.json || true
          
      - name: ğŸ” Secret scanning
        run: |
          echo "ğŸ” Scanning for secrets..."
          # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ truffleHog Ğ¸Ğ»Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚
          # npx trufflehog filesystem . --no-verification

  # ğŸ“Š ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
  nightly-performance:
    name: âš¡ Nightly Performance Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: âš¡ Performance analysis
        run: |
          echo "âš¡ Running performance analysis..."
          node scripts/performance-check.js
          
      - name: ğŸ“Š Bundle size analysis
        run: |
          echo "ğŸ“Š Analyzing bundle sizes..."
          # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ webpack-bundle-analyzer Ğ¸Ğ»Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ñ‹Ğ¹
          # npm run analyze
          
      - name: ğŸ§ª Performance tests
        run: |
          echo "ğŸ§ª Running performance tests..."
          # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ lighthouse-ci Ğ¸Ğ»Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ñ‹Ğ¹
          # npm run test:performance

  # ğŸ§ª ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  nightly-tests:
    name: ğŸ§ª Nightly Full Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: ğŸ§ª Run full test suite
        run: |
          echo "ğŸ§ª Running comprehensive test suite..."
          npm test -- --coverage --watchAll=false --verbose
          
      - name: ğŸ“Š Generate test report
        run: |
          echo "ğŸ“Š Generating detailed test report..."
          # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ HTML Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ²
          
      - name: ğŸ“ˆ Upload test results
        uses: actions/upload-artifact@v3
        with:
          name: nightly-test-results-${{ github.run_number }}
          path: |
            coverage/
            test-results/
          retention-days: 7

  # ğŸ—‘ï¸ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
  nightly-cleanup:
    name: ğŸ—‘ï¸ Nightly Cleanup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ—‘ï¸ Clean up old artifacts
        run: |
          echo "ğŸ—‘ï¸ Cleaning up old artifacts..."
          # Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²
          
      - name: ğŸ“Š Database maintenance
        run: |
          echo "ğŸ“Š Running database maintenance..."
          # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ VACUUM, Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ‚.Ğ´.
          
      - name: ğŸ§¹ Cache cleanup
        run: |
          echo "ğŸ§¹ Cleaning up caches..."
          # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… ĞºÑÑˆĞµĞ¹

  # ğŸ“ˆ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ²
  nightly-reports:
    name: ğŸ“ˆ Nightly Reports
    runs-on: ubuntu-latest
    needs: [nightly-security, nightly-performance, nightly-tests, nightly-cleanup]
    if: always()
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“ˆ Generate nightly report
        run: |
          echo "ğŸ“ˆ Generating nightly maintenance report..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚
          cat > nightly-report.md << EOF
          # ğŸŒ™ Nightly Maintenance Report
          
          **Date:** $(date)
          **Workflow:** ${{ github.workflow }}
          **Run ID:** ${{ github.run_id }}
          
          ## ğŸ”’ Security Scan
          - **Status:** ${{ needs.nightly-security.result }}
          - **Details:** Security vulnerabilities checked
          
          ## âš¡ Performance Analysis
          - **Status:** ${{ needs.nightly-performance.result }}
          - **Details:** Performance metrics analyzed
          
          ## ğŸ§ª Test Suite
          - **Status:** ${{ needs.nightly-tests.result }}
          - **Details:** Full test suite executed
          
          ## ğŸ—‘ï¸ Cleanup
          - **Status:** ${{ needs.nightly-cleanup.result }}
          - **Details:** System maintenance completed
          
          ## ğŸ“Š Summary
          All nightly maintenance tasks completed successfully.
          EOF
          
      - name: ğŸ“¤ Upload report
        uses: actions/upload-artifact@v3
        with:
          name: nightly-report-${{ github.run_number }}
          path: nightly-report.md
          retention-days: 30

  # ğŸ“¢ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ñ…
  nightly-notifications:
    name: ğŸ“¢ Nightly Notifications
    runs-on: ubuntu-latest
    needs: [nightly-reports]
    if: always()
    
    steps:
      - name: ğŸ“¢ Slack nightly notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#fixdrive-maintenance'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          custom_payload: |
            {
              "text": "ğŸŒ™ FixDrive Nightly Maintenance Complete",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸŒ™ FixDrive Nightly Maintenance Report*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Security:* ${{ needs.nightly-security.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Performance:* ${{ needs.nightly-performance.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Tests:* ${{ needs.nightly-tests.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Cleanup:* ${{ needs.nightly-cleanup.result }}"
                    }
                  ]
                }
              ]
            }
        if: always()
        
      - name: ğŸ“± Telegram nightly notification
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            MESSAGE="ğŸŒ™ <b>FixDrive Nightly Maintenance</b> completed successfully! âœ…

ğŸ”’ Security: ${{ needs.nightly-security.result }}
âš¡ Performance: ${{ needs.nightly-performance.result }}
ğŸ§ª Tests: ${{ needs.nightly-tests.result }}
ğŸ—‘ï¸ Cleanup: ${{ needs.nightly-cleanup.result }}

All systems are healthy! ğŸš€"
          else
            MESSAGE="âš ï¸ <b>FixDrive Nightly Maintenance</b> encountered issues! ğŸ”§

Please check the workflow for details."
          fi
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"$MESSAGE\",
              \"parse_mode\": \"HTML\"
            }"
        if: always()
